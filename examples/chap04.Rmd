Chapter 4
===============================================================================

```{r Preliminaries, message = FALSE, warning = FALSE, tidy = FALSE}
library(lme4)
library(dplyr)

varcomp <- function(obj) {
  components <- unlist(lapply(VarCorr(obj), diag))
  residual <- attr(VarCorr(obj), "sc")
  variance_components <- c(components, Residual = residual ^ 2)
  ICC <- components / sum(variance_components)
  list(var.components = variance_components, ICC = ICC)
}

# Access and pretty print a fixed effect coefficient
fixef2 <- function(model, variable) round(fixef(model)[variable], 2)

# Downloaded from http://www.stats.ox.ac.uk/~snijders/mlbook.htm
d <- read.table("mlbook2_r.dat", header = TRUE)
str(d)
```


Example 4.1
-------------------------------------------------------------------------------


Example 4.2
-------------------------------------------------------------------------------


Example 4.3: Within- and between-group regressions for IQ
-------------------------------------------------------------------------------

```{r}
m_3a <- lmer(langPOST ~ IQ_verb + sch_iqv + (1 | schoolnr), d, REML = FALSE)
summary(m_3a)
```

> Classes differ in two ways: they mave have different mean IQ values, whichs affects the expected results _Y_ through the term 1.312 * `sch_iqv` [i.e., mean IQ in class _j_]; this is an explained difference between the classes; and they have randomly differing values for _U_<sub>0_j_</sub>, which is an unexplained difference. These two ingredients contribute to the class-dependent intercept, given by 41.11 + _U_<sub>0_j_</sub> + 1.312 * `sch_iqv`.

### Within-group centering

```{r}
d <- mutate(d, dev_iqv = IQ_verb - sch_iqv)
m_3b <- lmer(langPOST ~ dev_iqv + sch_iqv + (1 | schoolnr), d, REML = FALSE)
summary(m_3b)
# Equivalently 
m_3c <- lmer(langPOST ~ I(IQ_verb - sch_iqv) + sch_iqv + (1 | schoolnr), d, REML = FALSE)
```

The within-group effect is `r fixef2(m_3b, "dev_iqv")`. The between-group effect is `r fixef2(m_3b, "sch_iqv")`. The advantage of within-group centering is that the within-group regression coefficient is now conveniently expressed in the model's fixed effects.








